name: Publish

on:
  push:
    tags:
      - '*' 

  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get tag SHA
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "$TAG"
          URL="https://github.com/alienengineer/is-my-code-great/archive/$TAG.tar.gz"
          echo "$URL"
          curl -LJO $URL
          FILE="is-my-code-great-${TAG#v}.tar.gz"
          SHA=$(shasum -a256 $FILE | awk '{print $1}')
          echo $SHA
          echo "sha256=$SHA" >> $GITHUB_ENV
          echo "version=$TAG" >> $GITHUB_ENV
          
      - name: Push new version
        env:
          TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }} //PAT
        run: |
          git config --global user.name "AlienEngineer"
          git config --global user.email "AlienEngineer@gmail.com"
          git clone https://AlienEngineer:${TARGET_REPO_TOKEN}@github.com/AlienEngineer/homebrew-tap.git
          cat > Formula/is-my-code-great.rb <<EOF 
            class IsMyCodeGreat < Formula
              desc "CLI to analyse Dart test code quality"
              homepage "https://github.com/alienengineer/is-my-code-great"
              url      "https://github.com/alienengineer/is-my-code-great/archive/${{ env.version }}.tar.gz"
              sha256   "${{ env.sha256 }}"}"

              def install
                lib.install Dir["lib/*"]
                bin.install "bin/is-my-code-great"
              end

              test do
                system "#{bin}/is-my-code-great", "--help"
              end
            end
          EOF

          git add .
          git commit -m "Automated commit"
          git push