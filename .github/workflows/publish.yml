name: Publish

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # Only run on valid version tags

  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g. v1.2.3)'
        required: true

jobs:
  publish-homebrew:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set version and SHA
        id: set_vars
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG=${{ github.event.inputs.tag }}
            echo "Running from workflow_dispatch for tag: $TAG"
          else
            TAG=${GITHUB_REF#refs/tags/}
            echo "Running from push for tag: $TAG"
          fi
          
          # This check is now redundant due to the trigger, but good for manual runs
          if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid tag format. Must be vX.X.X"
            exit 1
          fi

          echo "version=$TAG" >> $GITHUB_ENV
          
          URL="https://github.com/alienengineer/is-my-code-great/archive/$TAG.tar.gz"
          echo "Downloading from $URL"
          
          # Using curl with -f to fail on server errors
          curl -fLJO "$URL"
          
          FILE="is-my-code-great-${TAG#v}.tar.gz"
          SHA=$(shasum -a256 "$FILE" | awk '{print $1}')
          echo "sha256=$SHA" >> $GITHUB_ENV
          
      - name: Clone homebrew-tap
        env:
          TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
        run: |
          git config --global user.name "AlienEngineer"
          git config --global user.email "AlienEngineer@gmail.com"
          git clone https://AlienEngineer:${TARGET_REPO_TOKEN}@github.com/AlienEngineer/homebrew-tap.git
          
      - name: Update Homebrew formula
        run: |
          cd homebrew-tap
          cat > Formula/is-my-code-great.rb <<EOF
          class IsMyCodeGreat < Formula
            desc "CLI to analyse Dart test code quality"
            homepage "https://github.com/alienengineer/is-my-code-great"
            url      "https://github.com/alienengineer/is-my-code-great/archive/${{ env.version }}.tar.gz"
            sha256   "${{ env.sha256 }}"

            def install
              lib.install Dir["lib/*"]
              bin.install "bin/is-my-code-great"
              man1.install Dir["share/man/man1/*"]
            end

            test do
              bin_path = bin/"is-my-code-great"
              assert_predicate bin_path, :exist?, "Binary not installed"
              assert_predicate bin_path, :executable?, "Binary is not executable"
            end
          end
          EOF

      - name: Commit and push to homebrew-tap
        run: |
          cd homebrew-tap
          git add Formula/is-my-code-great.rb
          if git diff --staged --quiet; then
            echo "No changes to the formula. Nothing to commit."
          else
            git commit -m "Automated formula update to ${{ env.version }}"
            git push origin HEAD:main
          fi