#!/usr/bin/env bash
set -euo pipefail


show_help() {
	man is-my-code-great
}

FRAMEWORK=""
DIRS=()
VERBOSE=0
PARSEABLE=0
DETAILED=false
DETAILED_FILE="result.html"
EVALUATION=""
PER_PROJECT=0
RESULT_MODE="combined"  # Can be "combined" or "per-path"

while [[ $# -gt 0 ]]; do
	case $1 in
		-h|--help)
			show_help
			exit 0
			;;
		--per-project)
			PER_PROJECT=1
			shift
			;;
		--combined)
			RESULT_MODE="combined"
			shift
			;;
		--per-path)
			RESULT_MODE="per-path"
			shift
			;;
		-f|--framework)
			FRAMEWORK="$2"
			shift 2
			;;
		-d|--detailed)
			DETAILED=true
			shift
			;;
		-v|--verbose)
			VERBOSE=1
			shift
			;;
		-p|--parseable)
			PARSEABLE=1
			shift
			;;
		--)
			shift
			break
			;;
		-*)
			echo "Unknown option: $1" >&2
			show_help
			exit 1
			;;
		*)
			DIRS+=("$1")
			shift
			;;
	esac
done

if [ ${#DIRS[@]} -eq 0 ]; then
	DIRS=(".")
fi

export DETAILED VERBOSE PARSEABLE RESULT_MODE

source "$(dirname "$0")/../lib/analysis.sh"
source "$(dirname "$0")/../lib/core/framework-detect.sh"

if [ "$PER_PROJECT" -eq 1 ]; then
    # Framework-agnostic per-project mode
    if [ "$VERBOSE" = "1" ]; then
        echo "[main] Running in per-project mode (framework-agnostic)." >&2
    fi

    # Process each directory for project discovery
    for base_dir in "${DIRS[@]}"; do
        # Find all framework marker files
        while IFS= read -r -d $'\0' marker_file; do
            project_dir=$(dirname "$marker_file")
            
            # Detect framework for this project
            project_framework=$(detect_framework "$project_dir" "$VERBOSE" 2>/dev/null) || continue
            
            if [ "$VERBOSE" = "1" ]; then
                echo "[main] Found $project_framework project at: '$project_dir'"
            fi
            
            # Run with reporting (skip_report=0)
            run_analysis "$project_dir" "$project_framework" "$PARSEABLE" 0
            
        done < <(find "$base_dir" \( -name "pubspec.yaml" -o -name "*.csproj" -o -name "package.json" \) -print0)
    done
    
    exit 0
fi

# Multi-path analysis mode
if [ "$VERBOSE" = "1" ]; then
    echo "[main] Analyzing ${#DIRS[@]} path(s) in $RESULT_MODE mode" >&2
fi

if [ "$RESULT_MODE" = "per-path" ]; then
    # Per-path mode: Report after each path, clear results between paths
    for dir in "${DIRS[@]}"; do
        # Auto-detect framework if not specified
        dir_framework="$FRAMEWORK"
        if [ -z "$dir_framework" ]; then
            if [ "$VERBOSE" = "1" ]; then
                echo "[main] No framework specified for '$dir', attempting auto-detection..." >&2
            fi
            dir_framework=$(detect_framework "$dir" "$VERBOSE")
            if [ $? -ne 0 ]; then
                echo "Could not auto-detect framework for '$dir'. Please specify with -f." >&2
                exit 1
            fi
        fi

        if [ "$VERBOSE" = "1" ]; then
            echo "[main] FRAMEWORK: $dir_framework" >&2
            echo "[main] DIR: $dir" >&2
            echo "[main] DETAILED: $DETAILED" >&2
        fi
        
        # Clear results before each path (per-path mode)
        clear_validation_results
        
        # Run analysis with reporting (skip_report=0)
        run_analysis "$dir" "$dir_framework" "$PARSEABLE" 0
        
        # Print separator between paths
        if [ ${#DIRS[@]} -gt 1 ]; then
            echo ""
            echo "=========================================="
            echo ""
        fi
    done
else
    # Combined mode: Accumulate results across all paths, report once at the end
    for dir in "${DIRS[@]}"; do
        # Auto-detect framework if not specified
        dir_framework="$FRAMEWORK"
        if [ -z "$dir_framework" ]; then
            if [ "$VERBOSE" = "1" ]; then
                echo "[main] No framework specified for '$dir', attempting auto-detection..." >&2
            fi
            dir_framework=$(detect_framework "$dir" "$VERBOSE")
            if [ $? -ne 0 ]; then
                echo "Could not auto-detect framework for '$dir'. Please specify with -f." >&2
                exit 1
            fi
        fi

        if [ "$VERBOSE" = "1" ]; then
            echo "[main] FRAMEWORK: $dir_framework" >&2
            echo "[main] DIR: $dir" >&2
            echo "[main] DETAILED: $DETAILED" >&2
        fi
        
        # Run analysis without reporting (skip_report=1)
        run_analysis "$dir" "$dir_framework" "$PARSEABLE" 1
    done
    
    # Report combined results
    if [ "$PARSEABLE" = "1" ]; then
        print_validations_parseable
    else
        printf "\nIs my code great? "
        print_summary
        export_report
    fi
fi
